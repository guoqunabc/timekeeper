<!doctype html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>ä¼šè®®è®¡æ—¶å™¨</title>
    <style>
      /* ========== å­—ä½“åŠ è½½ ========== */
      @font-face {
        font-family: "Arial Local";
        src: url("fonts/Arial.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "DIN Pro";
        src: url("fonts/DINPro-Regular.otf") format("opentype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      body {
        margin: 0;
        padding: 0;
        background-color: black;
        color: white;
        font-family: "Arial Local", Arial, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        /* ä¸»é¢˜åˆ‡æ¢åŠ¨ç”» */
        transition:
          background-color 0.3s ease,
          color 0.3s ease;
      }

      .timer-container {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: background 0.3s ease;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin-top: -20vh;
        position: relative;
        z-index: 50;
      }

      #timer {
        font-family: "DIN Pro", monospace;
        font-size: 30vw;
        font-weight: bold;
        line-height: 1.3;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        letter-spacing: 0.02em;
        height: 50vh;
        position: relative;
        z-index: 50;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .timer-minutes,
      .timer-seconds {
        width: 1.1em;
        text-align: center;
        display: flex;
        align-items: center;
        height: 100%;
      }

      .timer-separator {
        width: 0.4em;
        text-align: center;
        display: flex;
        align-items: center;
        height: 100%;
        position: relative;
        top: -0.08em;
      }

      .controls {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
      }

      button {
        font-size: 1.8em;
        margin: 0 15px;
        padding: 15px 30px;
        cursor: pointer;
        background-color: #333;
        color: white;
        border: none;
        border-radius: 5px;
        transition:
          background-color 0.3s ease,
          color 0.3s ease,
          transform 0.1s ease;
      }

      button:hover {
        background-color: #444;
      }

      button:active {
        transform: scale(0.98);
      }

      button:disabled {
        background-color: #222;
        color: #666;
        cursor: not-allowed;
        transform: none;
      }

      .time-input {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 120px;
        font-size: 2em;
        z-index: 100;
      }

      .time-input-group {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }

      input {
        font-size: 1.1em;
        width: 80px;
        padding: 8px;
        margin: 0;
        background-color: #333;
        color: white;
        border: 1px solid #555;
        border-radius: 5px;
        text-align: center;
        height: 58px;
        box-sizing: border-box;
        transition:
          background-color 0.3s ease,
          color 0.3s ease,
          border-color 0.3s ease,
          box-shadow 0.3s ease;
        /* å…è®¸è¾“å…¥æ¡†å†…æ–‡æœ¬é€‰æ‹© */
        -webkit-user-select: text;
        user-select: text;
      }

      input:focus {
        outline: none;
        border-color: #2962ff;
        box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.3);
      }

      input:invalid {
        border-color: #cc0000;
      }

      #minutes,
      #seconds {
        margin: 0 2px;
      }

      #speakerName {
        font-size: 22px !important;
        width: 180px;
        padding: 8px;
        margin: 0;
        background-color: #333;
        color: white;
        border: 1px solid #555;
        border-radius: 5px;
        text-align: center;
        height: 58px;
        box-sizing: border-box;
        margin-right: 15px;
      }

      #speakerName::placeholder {
        color: #888;
      }

      #speakerName:focus {
        outline: none;
        border-color: #666;
      }

      .time-input-group span {
        margin: 0 2px;
        font-weight: bold;
        display: inline-block;
        position: relative;
        top: -2px;
      }

      #startBtn,
      #stopBtn {
        font-size: 1em;
        padding: 8px 24px;
        min-width: 80px;
        height: 58px;
        box-sizing: border-box;
        line-height: 1;
        font-weight: bold;
        white-space: nowrap;
      }

      #startBtn {
        margin: 0;
      }

      #stopBtn {
        margin-left: 15px;
        background-color: #cc0000;
        color: #fff;
      }

      .records-section {
        width: 100%;
        height: 25vh;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.95);
        display: flex;
        flex-direction: column;
        z-index: 150;
        pointer-events: auto;
      }

      .records-title {
        padding: 3px 0 15px 0;
        position: sticky;
        top: 0;
        background-color: rgba(0, 0, 0, 0.98);
        z-index: 151;
        text-align: center;
        border-bottom: 1px solid #444;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        pointer-events: auto;
      }

      .record-controls {
        display: flex;
        gap: 10px;
        z-index: 152;
        position: relative;
        pointer-events: auto;
      }

      .record-controls button {
        font-size: 0.8em;
        padding: 5px 10px;
        margin: 0;
        cursor: pointer;
        pointer-events: auto;
        z-index: 153;
        position: relative;
      }

      .export-btn {
        background-color: #2962ff;
      }

      .export-btn:hover {
        background-color: #1e4bd8;
      }

      .clear-btn {
        background-color: #cc0000;
      }

      .clear-btn:hover {
        background-color: #aa0000;
      }

      h2 {
        color: #aaa;
        font-size: 1.3em;
        margin: 0;
        font-weight: normal;
        letter-spacing: 0.05em;
      }

      .records {
        color: #888;
        padding: 10px 40px 0;
        overflow-y: auto;
        flex-grow: 1;
        position: relative;
        z-index: 150;
        pointer-events: auto;
      }

      #recordList {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px 20px;
        padding: 10px 0;
        margin: 0 20px;
      }

      .record-item {
        font-size: 1.1em;
        margin: 0;
        padding: 3px 5px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .record-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .record-content {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .delete-record-btn {
        font-size: 1.2em;
        padding: 2px 6px;
        margin: 0;
        margin-left: 8px;
        background-color: #cc0000;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.3s;
        flex-shrink: 0;
      }

      .delete-record-btn:hover {
        opacity: 1;
        background-color: #aa0000;
      }

      .record-item:hover .delete-record-btn {
        opacity: 1;
      }

      .scroll-indicator {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        color: rgba(136, 136, 136, 0.5);
        font-size: 20px;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .scroll-indicator::before,
      .scroll-indicator::after {
        content: ">";
        display: inline-block;
        transform: rotate(90deg);
        margin: 0 -3px;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateX(-50%) translateY(0);
        }
        50% {
          transform: translateX(-50%) translateY(8px);
        }
      }

      .button-group {
        margin-left: 60px;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .confirm-dialog {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.95);
        padding: 35px;
        border-radius: 10px;
        border: 1px solid #444;
        text-align: center;
        z-index: 1000;
      }

      .confirm-dialog p {
        font-size: 1.5em;
        margin: 0 0 30px 0;
        color: #fff;
      }

      .confirm-dialog-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
      }

      .confirm-dialog button {
        font-size: 1.2em;
        padding: 10px 25px;
        min-width: 100px;
      }

      #confirmYes {
        background-color: #2962ff;
      }

      #confirmYes:hover {
        background-color: #1e4bd8;
      }

      #confirmNo {
        background-color: #333;
      }

      #confirmNo:hover {
        background-color: #444;
      }

      .confirm-dialog-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 999;
      }

      @media (max-width: 1200px) {
        #recordList {
          grid-template-columns: repeat(2, 1fr);
        }
      }



      /* Toast æç¤ºæ¡† */
      .toast-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        background-color: rgba(50, 50, 50, 0.9);
        color: #fff;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        z-index: 2000;
        opacity: 0;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        pointer-events: none;
      }

      .toast-message.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      body.light-theme .toast-message {
        background-color: rgba(255, 255, 255, 0.95);
        color: #333;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      @keyframes overtime-blink {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
          text-shadow:
            0 0 20px rgba(255, 0, 0, 0.5),
            0 0 40px rgba(255, 0, 0, 0.3);
        }
        50% {
          opacity: 0.7;
          transform: scale(var(--scale-factor, 0.92));
          text-shadow:
            0 0 30px rgba(255, 0, 0, 0.7),
            0 0 60px rgba(255, 0, 0, 0.5);
        }
      }

      #timer.overtime-animation {
        animation-name: overtime-blink;
        animation-duration: var(--blink-duration, 1s);
        animation-timing-function: ease-in-out;
        animation-iteration-count: infinite;
        animation-fill-mode: both;
        transform-origin: center center;
      }

      input::placeholder {
        color: #555;
        opacity: 1;
      }

      @keyframes warning-blink {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
          text-shadow:
            0 0 20px rgba(255, 200, 0, 0.5),
            0 0 40px rgba(255, 200, 0, 0.3);
        }
        50% {
          opacity: 0.75;
          transform: scale(0.95);
          text-shadow:
            0 0 30px rgba(255, 200, 0, 0.6),
            0 0 60px rgba(255, 200, 0, 0.4);
        }
      }

      #timer.warning-animation {
        color: #ffd700;
        animation-name: warning-blink;
        animation-duration: 1.2s;
        animation-timing-function: ease-in-out;
        animation-iteration-count: infinite;
        animation-fill-mode: both;
        transform-origin: center center;
      }

      /* ========== è®®ç¨‹é…ç½®é¢æ¿æ ·å¼ ========== */
      .config-toggle-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 44px;
        height: 44px;
        background: rgba(50, 50, 50, 0.9);
        border: 1px solid #555;
        border-radius: 50%;
        color: #aaa;
        font-size: 20px;
        cursor: pointer;
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
      }

      .config-toggle-btn:hover {
        background: rgba(70, 70, 70, 0.9);
        color: #fff;
        transform: rotate(45deg);
      }

      .config-toggle-btn.active {
        background: rgba(41, 98, 255, 0.9);
        color: #fff;
        transform: rotate(45deg);
      }

      .config-panel-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 300;
        -webkit-backdrop-filter: blur(4px);
        backdrop-filter: blur(4px);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .config-panel-overlay.show {
        display: block;
        opacity: 1;
      }

      .config-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 480px;
        max-width: 90vw;
        max-height: 80vh;
        background: rgba(30, 30, 30, 0.98);
        border: 1px solid #444;
        border-radius: 16px;
        z-index: 301;
        display: none;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        opacity: 0;
        transition: all 0.3s ease;
      }

      .config-panel.show {
        display: flex;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }

      .config-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #444;
      }

      .config-panel-header h3 {
        margin: 0;
        font-size: 1.2em;
        font-weight: 500;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .config-panel-close {
        background: none;
        border: none;
        color: #888;
        font-size: 24px;
        cursor: pointer;
        padding: 4px 8px;
        margin: 0;
        line-height: 1;
        transition: color 0.2s;
      }

      .config-panel-close:hover {
        color: #fff;
        background: none;
      }

      .config-panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px 20px;
      }

      .speaker-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .speaker-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: rgba(50, 50, 50, 0.6);
        border: 1px solid #444;
        border-radius: 8px;
        transition: all 0.2s;
      }

      .speaker-item:hover {
        border-color: #666;
        background: rgba(60, 60, 60, 0.8);
      }

      .speaker-item.dragging {
        opacity: 0.5;
        border-color: #2962ff;
      }

      .speaker-drag-handle {
        cursor: grab;
        color: #999;
        font-size: 16px;
        padding: 4px;
        user-select: none;
        opacity: 0.4;
        transition: opacity 0.2s ease;
      }

      .speaker-item:hover .speaker-drag-handle {
        opacity: 0.8;
      }

      .speaker-drag-handle:active {
        cursor: grabbing;
      }

      .speaker-index {
        min-width: 24px;
        height: 24px;
        background: #444;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: #aaa;
        flex-shrink: 0;
      }

      .speaker-name-input {
        flex: 1;
        min-width: 120px;
        font-size: 14px !important;
        padding: 8px 12px !important;
        height: auto !important;
      }

      .speaker-time-inputs {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .speaker-time-input {
        width: 50px !important;
        font-size: 14px !important;
        padding: 8px !important;
        height: auto !important;
        text-align: center;
      }

      .speaker-time-sep {
        color: #888;
        font-weight: bold;
      }

      .speaker-time-label {
        color: #666;
        font-size: 12px;
        margin-left: 2px;
      }

      .speaker-delete-btn {
        background: none;
        border: none;
        color: #666;
        font-size: 18px;
        cursor: pointer;
        padding: 4px 8px;
        margin: 0;
        transition: color 0.2s;
      }

      .speaker-delete-btn:hover {
        color: #ff4444;
        background: none;
      }

      .add-speaker-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 12px;
        margin: 10px 0 0 0;
        background: rgba(41, 98, 255, 0.15);
        border: 1px dashed #2962ff;
        border-radius: 8px;
        color: #2962ff;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .add-speaker-btn:hover {
        background: rgba(41, 98, 255, 0.25);
      }

      .config-panel-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-top: 1px solid #444;
        gap: 10px;
      }

      .config-footer-left {
        display: flex;
        gap: 8px;
      }

      .config-btn {
        padding: 10px 16px;
        font-size: 13px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        margin: 0;
      }

      .config-btn-secondary {
        background: #444;
        color: #ddd;
      }

      .config-btn-secondary:hover {
        background: #555;
      }

      .config-btn-primary {
        background: #2962ff;
        color: #fff;
      }

      .config-btn-primary:hover {
        background: #1e4bd8;
      }

      /* å±é™©æ“ä½œæŒ‰é’®æ ·å¼ï¼ˆæ¸…ç©ºç­‰ï¼‰ */
      .config-btn-danger {
        background: #e74c3c;
        color: #fff;
        border-color: #e74c3c;
      }

      .config-btn-danger:hover {
        background: #c0392b;
      }

      .empty-speakers-hint {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .empty-speakers-hint p {
        margin: 0 0 16px 0;
        font-size: 14px;
      }
      /* Drag & Drop Highlight */
      .config-panel.dragging-file {
        border: 2px dashed #007bff !important;
        background-color: rgba(0, 123, 255, 0.1);
      }
      .config-panel.dragging-file .config-panel-body {
        pointer-events: none; /* Let drag events bubble to panel */
      }

      .drag-hint {
        text-align: center;
        color: #888;
        font-size: 12px;
        margin: 15px 0 0 0;
        pointer-events: none;
        border: 1px dashed #ccc;
        border-radius: 4px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.05);
      }

      /* ========== è¯­è¨€åˆ‡æ¢æŒ‰é’®æ ·å¼ ========== */
      .lang-toggle-btn {
        position: fixed;
        top: 74px;
        right: 20px;
        width: 44px;
        height: 44px;
        background: rgba(50, 50, 50, 0.9);
        border: 1px solid #555;
        border-radius: 50%;
        color: #aaa;
        font-size: 16px;
        cursor: pointer;
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        font-weight: bold;
      }

      .lang-toggle-btn:hover {
        background: rgba(70, 70, 70, 0.9);
        color: #fff;
        transform: scale(1.1);
      }

      .lang-toggle-btn.active {
        background: rgba(76, 175, 80, 0.9);
        color: #fff;
      }

      /* ========== ä¸»é¢˜åˆ‡æ¢æŒ‰é’®æ ·å¼ ========== */
      .theme-toggle-btn {
        position: fixed;
        top: 128px;
        right: 20px;
        width: 44px;
        height: 44px;
        background: rgba(50, 50, 50, 0.9);
        border: 1px solid #555;
        border-radius: 50%;
        color: #aaa;
        font-size: 20px;
        cursor: pointer;
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
      }

      .theme-toggle-btn:hover {
        background: rgba(70, 70, 70, 0.9);
        transform: scale(1.1);
      }

      .theme-toggle-btn.active {
        background: rgba(255, 193, 7, 0.2);
        border-color: rgba(255, 193, 7, 0.5);
      }

      /* ========== äº®è‰²ä¸»é¢˜ ========== */
      body.light-theme {
        background-color: #f0f4ff;
        color: #2c3e50;
      }

      body.light-theme .timer-container {
        background: linear-gradient(135deg, #6495ed 0%, #4169e1 100%);
      }

      body.light-theme #timer {
        color: #fff;
        text-shadow:
          0 2px 4px rgba(0, 0, 0, 0.1),
          0 4px 20px rgba(100, 149, 237, 0.3);
      }

      body.light-theme input,
      body.light-theme #speakerName {
        background-color: rgba(255, 255, 255, 0.95);
        color: #2c3e50;
        border-color: rgba(100, 149, 237, 0.3);
      }

      body.light-theme input::placeholder,
      body.light-theme #speakerName::placeholder {
        color: #95a5a6;
      }

      body.light-theme input:focus,
      body.light-theme #speakerName:focus {
        border-color: #6495ed;
        box-shadow: 0 0 0 3px rgba(100, 149, 237, 0.15);
      }

      body.light-theme button {
        background-color: #6495ed;
        color: #fff;
        border-color: #6495ed;
      }

      body.light-theme button:hover {
        background-color: #4169e1;
      }

      body.light-theme #stopBtn {
        background-color: #e74c3c;
      }

      body.light-theme #stopBtn:hover {
        background-color: #c0392b;
      }

      /* åº•éƒ¨æ¸…ç©ºæŒ‰é’® - çº¢è‰² */
      body.light-theme .clear-btn {
        background-color: #e74c3c;
        border-color: #e74c3c;
      }

      body.light-theme .clear-btn:hover {
        background-color: #c0392b;
      }

      /* å¯¼å‡ºæŒ‰é’®ä¿æŒè“è‰² */
      body.light-theme .export-btn {
        background-color: #6495ed;
        border-color: #6495ed;
      }

      body.light-theme .export-btn:hover {
        background-color: #4169e1;
      }

      body.light-theme .records-section {
        background-color: rgba(255, 255, 255, 0.97);
        border-top: 1px solid rgba(100, 149, 237, 0.2);
      }

      body.light-theme .records-title {
        background-color: rgba(255, 255, 255, 0.99);
        border-bottom-color: rgba(100, 149, 237, 0.2);
      }

      body.light-theme h2 {
        color: #34495e;
      }

      body.light-theme .records {
        color: #2c3e50;
      }

      body.light-theme .record-item {
        background: rgba(100, 149, 237, 0.08);
        border-color: rgba(100, 149, 237, 0.25);
      }

      body.light-theme .record-item:hover {
        background: rgba(100, 149, 237, 0.15);
      }

      body.light-theme .delete-record-btn {
        background-color: #e74c3c;
        color: #fff;
      }

      body.light-theme .config-toggle-btn,
      body.light-theme .lang-toggle-btn,
      body.light-theme .theme-toggle-btn {
        background: rgba(255, 255, 255, 0.95);
        color: #6495ed;
        border-color: rgba(100, 149, 237, 0.3);
      }

      body.light-theme .config-toggle-btn:hover,
      body.light-theme .lang-toggle-btn:hover,
      body.light-theme .theme-toggle-btn:hover {
        background: rgba(255, 255, 255, 1);
        color: #4169e1;
        box-shadow: 0 4px 12px rgba(100, 149, 237, 0.2);
      }

      /* é…ç½®é¢æ¿ä¼˜åŒ– */
      body.light-theme .config-panel {
        background-color: rgba(255, 255, 255, 0.98);
        color: #2c3e50;
        border-color: rgba(100, 149, 237, 0.3);
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.15);
      }

      body.light-theme .config-panel-header {
        border-bottom-color: rgba(100, 149, 237, 0.2);
      }

      body.light-theme .config-panel h3 {
        color: #2c3e50;
      }

      /* è®®ç¨‹åˆ—è¡¨é¡¹ä¼˜åŒ– - æ”¹å–„å¯¹æ¯”åº¦ */
      body.light-theme .speaker-item {
        background: rgba(100, 149, 237, 0.05);
        border: 1px solid rgba(100, 149, 237, 0.2);
        border-radius: 8px;
      }

      body.light-theme .speaker-item:hover {
        background: rgba(100, 149, 237, 0.1);
      }

      body.light-theme .speaker-index {
        background: #6495ed;
        color: #fff;
      }

      body.light-theme .speaker-name-input,
      body.light-theme .speaker-time-input {
        background-color: #fff;
        color: #2c3e50;
        border: 1px solid rgba(100, 149, 237, 0.3);
      }

      body.light-theme .speaker-name-input:focus,
      body.light-theme .speaker-time-input:focus {
        border-color: #6495ed;
        box-shadow: 0 0 0 3px rgba(100, 149, 237, 0.1);
      }

      /* é…ç½®é¢æ¿æŒ‰é’®ä¼˜åŒ– */
      body.light-theme .speaker-controls button {
        background-color: #6495ed;
        color: #fff;
      }

      body.light-theme .speaker-controls .delete-speaker-btn {
        background-color: #e74c3c;
      }

      body.light-theme .speaker-controls .delete-speaker-btn:hover {
        background-color: #c0392b;
      }

      body.light-theme #addSpeakerBtn {
        background-color: #27ae60;
        border-color: #27ae60;
      }

      body.light-theme #addSpeakerBtn:hover {
        background-color: #229954;
      }

      body.light-theme #clearAgendaBtn {
        background-color: #e74c3c;
        border-color: #e74c3c;
        color: #fff !important;
      }

      body.light-theme #clearAgendaBtn:hover {
        background-color: #c0392b;
      }

      body.light-theme .confirm-dialog {
        background-color: rgba(255, 255, 255, 0.98);
        border-color: rgba(100, 149, 237, 0.3);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      body.light-theme .confirm-dialog p {
        color: #2c3e50;
      }

      body.light-theme .confirm-dialog-overlay {
        background: rgba(0, 0, 0, 0.4);
      }

      body.light-theme .export-dialog {
        background-color: rgba(255, 255, 255, 0.98);
        border-color: rgba(100, 149, 237, 0.3);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      body.light-theme .export-dialog h3 {
        color: #2c3e50;
        border-bottom-color: rgba(100, 149, 237, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="timer-container">
      <div class="time-input">
        <div class="time-input-group">
          <input type="text" id="speakerName" placeholder="æ¼”è®²è€…" />
          <input
            type="number"
            id="minutes"
            min="0"
            value="10"
            placeholder="åˆ†"
          />
          <span>:</span>
          <input
            type="number"
            id="seconds"
            min="0"
            max="59"
            value="00"
            placeholder="ç§’"
          />
          <div class="button-group">
            <button id="startBtn">å¼€å§‹</button>
            <button id="stopBtn" disabled>åœæ­¢</button>
          </div>
        </div>
      </div>

      <div class="main-content">
        <div id="timer">
          <span class="timer-minutes">10</span>
          <span class="timer-separator">:</span>
          <span class="timer-seconds">00</span>
        </div>
      </div>

      <div class="records-section">
        <div class="records-title">
          <h2>æ¼”è®²æ—¶é—´è®°å½•</h2>
          <div class="record-controls">
            <button class="export-btn" type="button">å¯¼å‡º</button>
            <button class="clear-btn" type="button">æ¸…ç©º</button>
          </div>
        </div>
        <div class="records">
          <div id="recordList"></div>
          <div class="scroll-indicator"></div>
        </div>
      </div>
    </div>
    <div class="confirm-dialog-overlay"></div>
    <div class="confirm-dialog">
      <p>ç¡®å®šç»“æŸè®¡æ—¶å—ï¼Ÿ</p>
      <div class="confirm-dialog-buttons">
        <button id="confirmYes">ç¡®å®š</button>
        <button id="confirmNo">å–æ¶ˆ</button>
      </div>
    </div>

    <!-- é…ç½®é¢æ¿ -->
    <button class="config-toggle-btn" id="configToggleBtn" title="è®®ç¨‹é…ç½®">
      âš™
    </button>
    <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
    <button class="lang-toggle-btn" id="langToggleBtn" title="åˆ‡æ¢è¯­è¨€">
      ä¸­
    </button>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle-btn" id="themeToggleBtn" title="åˆ‡æ¢ä¸»é¢˜">
      â˜€ï¸
    </button>
    <div class="config-panel-overlay" id="configPanelOverlay"></div>
    <div class="config-panel" id="configPanel">
      <div class="config-panel-header">
        <h3>ğŸ“‹ ä¼šè®®è®®ç¨‹é…ç½®</h3>
        <button class="config-panel-close" id="configPanelClose">Ã—</button>
      </div>
      <div class="config-panel-body">
        <div class="speaker-list" id="speakerList"></div>
        <button class="add-speaker-btn" id="addSpeakerBtn">+ æ·»åŠ æ¼”è®²è€…</button>
        <div class="drag-hint">æ”¯æŒæ‹–æ‹½ .csv / .json æ–‡ä»¶è‡³æ­¤åŒºåŸŸç›´æ¥å¯¼å…¥</div>
      </div>
      <div class="config-panel-footer">
        <div class="config-footer-left">
          <button class="config-btn config-btn-secondary" id="importAgendaBtn">
            å¯¼å…¥
          </button>
          <button class="config-btn config-btn-secondary" id="exportAgendaBtn">
            å¯¼å‡º
          </button>
          <button class="config-btn config-btn-danger" id="clearAgendaBtn">
            æ¸…ç©º
          </button>
        </div>
        <button class="config-btn config-btn-primary" id="applyAgendaBtn">
          ä¿å­˜å¹¶åº”ç”¨
        </button>
      </div>
    </div>
    <input
      type="file"
      id="agendaFileInput"
      accept=".json,.csv"
      style="display: none"
    />

    <!-- å¯¼å‡ºæ ¼å¼é€‰æ‹©å¼¹çª— -->
    <div class="confirm-dialog" id="exportDialog">
      <p>è¯·é€‰æ‹©å¯¼å‡ºæ ¼å¼</p>
      <div class="confirm-dialog-buttons">
        <button id="exportJsonBtn" style="background-color: #2962ff">
          JSON (å¤‡ä»½)
        </button>
        <button id="exportCsvBtn" style="background-color: #28a745">
          CSV (Excel)
        </button>
        <button id="exportCancelBtn" style="background-color: #333">
          å–æ¶ˆ
        </button>
      </div>
    </div>
    <div class="confirm-dialog-overlay" id="exportOverlay"></div>

    <!-- ç½²å -->
    <div class="powered-by">Powered by é»„é¾™ä¸­ & è¿‡å°å‡¡</div>
    <style>
      .powered-by {
        position: fixed;
        bottom: 8px;
        right: 12px;
        font-size: 16px;
        color: rgba(255, 255, 255, 0.15);
        z-index: 2000;
        pointer-events: none;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        letter-spacing: 0.5px;
      }
      body.light-theme .powered-by {
        color: rgba(255, 255, 255, 0.3);
      }
    </style>


    <script src="src/Timer.js"></script>
    <script>
      // ========== AgendaManager è®®ç¨‹é…ç½®ç®¡ç†æ¨¡å— ==========
      class AgendaManager {
        constructor() {
          this.speakers = [];
          this.isOpen = false;
          this.draggedItem = null;

          // DOM å…ƒç´ 
          this.toggleBtn = document.getElementById("configToggleBtn");
          this.panel = document.getElementById("configPanel");
          this.overlay = document.getElementById("configPanelOverlay");
          this.closeBtn = document.getElementById("configPanelClose");
          this.speakerList = document.getElementById("speakerList");
          this.addBtn = document.getElementById("addSpeakerBtn");
          this.importBtn = document.getElementById("importAgendaBtn");
          this.exportBtn = document.getElementById("exportAgendaBtn");
          this.clearBtn = document.getElementById("clearAgendaBtn");
          this.applyBtn = document.getElementById("applyAgendaBtn");
          this.fileInput = document.getElementById("agendaFileInput");

          // å¯¼å‡ºå¼¹çª—å…ƒç´ 
          this.exportDialog = document.getElementById("exportDialog");
          this.exportOverlay = document.getElementById("exportOverlay");
          this.exportJsonBtn = document.getElementById("exportJsonBtn");
          this.exportCsvBtn = document.getElementById("exportCsvBtn");
          this.exportCancelBtn = document.getElementById("exportCancelBtn");

          // æ¸…ç©ºç¡®è®¤å¯¹è¯æ¡†å…ƒç´ 
          this.clearConfirmDialog =
            document.getElementById("clearConfirmDialog");
          this.clearConfirmOverlay = document.getElementById(
            "clearConfirmOverlay",
          );
          this.clearConfirmYesBtn = document.getElementById("clearConfirmYes");
          this.clearConfirmNoBtn = document.getElementById("clearConfirmNo");

          this.initializeEventListeners();
          this.loadFromStorage();

          // Expose for external sync
          window.agendaManager = this;
        }

        initializeEventListeners() {
          // æ‰“å¼€/å…³é—­é¢æ¿
          this.toggleBtn.addEventListener("click", () => this.togglePanel());
          this.closeBtn.addEventListener("click", () => this.closePanel());
          this.overlay.addEventListener("click", () => this.closePanel());

          // æ·»åŠ æ¼”è®²è€…
          this.addBtn.addEventListener("click", () => this.addSpeaker());

          // å¯¼å…¥/å¯¼å‡º/åº”ç”¨
          this.importBtn.addEventListener("click", () =>
            this.fileInput.click(),
          );
          this.exportBtn.addEventListener("click", () =>
            this.showExportDialog(),
          );
          this.clearBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.showClearConfirmDialog();
          });
          this.applyBtn.addEventListener("click", () => this.applyAndClose());
          this.fileInput.addEventListener("change", (e) =>
            this.importAgenda(e),
          );

          // å¯¼å‡ºå¼¹çª—äº‹ä»¶
          this.exportJsonBtn.addEventListener("click", () => {
            this.exportAsJson();
            this.hideExportDialog();
          });
          this.exportCsvBtn.addEventListener("click", () => {
            this.exportAsCsv();
            this.hideExportDialog();
          });
          this.exportCancelBtn.addEventListener("click", () =>
            this.hideExportDialog(),
          );
          this.exportOverlay.addEventListener("click", () =>
            this.hideExportDialog(),
          );

          // ESC é”®å…³é—­
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              if (this.exportDialog.style.display === "block") {
                this.hideExportDialog();
              } else if (
                this.clearConfirmDialog &&
                this.clearConfirmDialog.style.display === "block"
              ) {
                this.hideClearConfirmDialog();
              } else if (this.isOpen) {
                this.closePanel();
              }
            }
          });
          // File Drop Support
          this.panel.addEventListener("dragover", (e) =>
            this.handleFileDragOver(e),
          );
          this.panel.addEventListener("dragleave", (e) =>
            this.handleFileDragLeave(e),
          );
          this.panel.addEventListener("drop", (e) => this.handleFileDrop(e));
        }

        togglePanel() {
          if (this.isOpen) {
            this.closePanel();
          } else {
            this.openPanel();
          }
        }

        openPanel() {
          this.isOpen = true;
          this.toggleBtn.classList.add("active");
          this.overlay.classList.add("show");
          this.panel.classList.add("show");
          this.renderSpeakerList();
        }

        closePanel() {
          this.isOpen = false;
          this.toggleBtn.classList.remove("active");
          this.overlay.classList.remove("show");
          this.panel.classList.remove("show");
        }

        showExportDialog() {
          this.exportDialog.style.display = "block";
          this.exportOverlay.style.display = "block";
        }

        hideExportDialog() {
          this.exportDialog.style.display = "none";
          this.exportOverlay.style.display = "none";
        }

        loadFromStorage() {
          try {
            const saved = localStorage.getItem("agendaSpeakers");
            if (saved) {
              this.speakers = JSON.parse(saved);
            } else if (
              window.TIMEKEEPER_CONFIG &&
              window.TIMEKEEPER_CONFIG.speakers
            ) {
              // é¦–æ¬¡åŠ è½½æ—¶ä»é…ç½®æ–‡ä»¶è¯»å–
              this.speakers = [...window.TIMEKEEPER_CONFIG.speakers];
            }

            // ç¡®ä¿åŒæ­¥ç»™ Timer
            if (this.speakers.length > 0 && window.timeKeeper) {
              window.timeKeeper.agendaSpeakers = this.speakers;
              window.timeKeeper.isAgendaMode = true;
              // ä»…å½“ Timer æœªæ¢å¤çŠ¶æ€æ—¶ï¼Œé‡ç½®ä¸ºç¬¬ä¸€ä¸ªæ¼”è®²è€…
              if (!window.timeKeeper.isStateRestored) {
                window.timeKeeper.setCurrentSpeaker(0);
              }
            }
          } catch (error) {
            console.error("åŠ è½½è®®ç¨‹é…ç½®å¤±è´¥:", error);
            this.speakers = [];
          }
        }

        saveToStorage() {
          try {
            localStorage.setItem(
              "agendaSpeakers",
              JSON.stringify(this.speakers),
            );
          } catch (error) {
            console.error("ä¿å­˜è®®ç¨‹é…ç½®å¤±è´¥:", error);
          }
        }

        // Sync from main timer inputs
        syncFromTimer(updatedSpeakers) {
          this.speakers = updatedSpeakers;
          this.saveToStorage();
          if (this.isOpen) {
            this.renderSpeakerList();
          }
        }

        renderSpeakerList() {
          if (this.speakers.length === 0) {
            this.speakerList.innerHTML = `
                    <div class="empty-speakers-hint">
                        <p>æš‚æ— æ¼”è®²è€…</p>
                        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ¼”è®²è€…</p>
                    </div>
                `;
            return;
          }

          this.speakerList.innerHTML = this.speakers
            .map(
              (speaker, index) => `
                <div class="speaker-item" data-index="${index}" draggable="true">
                    <span class="speaker-drag-handle">â‹®â‹®</span>
                    <span class="speaker-index">${index + 1}</span>
                    <input type="text" class="speaker-name-input" value="${this.escapeHtml(speaker.name)}" 
                           placeholder="å§“å" data-field="name" data-index="${index}">
                    <div class="speaker-time-inputs">
                        <input type="number" class="speaker-time-input" value="${speaker.minutes || 0}" 
                               min="0" max="999" data-field="minutes" data-index="${index}">
                        <span class="speaker-time-label">åˆ†</span>
                        <span class="speaker-time-sep">:</span>
                        <input type="number" class="speaker-time-input" value="${(speaker.seconds || 0).toString().padStart(2, "0")}" 
                               min="0" max="59" data-field="seconds" data-index="${index}">
                        <span class="speaker-time-label">ç§’</span>
                    </div>
                    <button class="speaker-delete-btn" data-index="${index}" title="åˆ é™¤">Ã—</button>
                </div>
            `,
            )
            .join("");

          this.bindSpeakerEvents();
        }

        bindSpeakerEvents() {
          // è¾“å…¥äº‹ä»¶
          this.speakerList.querySelectorAll("input").forEach((input) => {
            input.addEventListener("input", (e) => {
              const index = parseInt(e.target.dataset.index);
              const field = e.target.dataset.field;
              let value = e.target.value;

              if (field === "minutes" || field === "seconds") {
                value = Math.max(0, parseInt(value) || 0);
                if (field === "seconds") value = Math.min(59, value);
                if (field === "minutes") value = Math.min(999, value);
              }

              this.speakers[index][field] = value;
            });
          });

          // åˆ é™¤æŒ‰é’®
          this.speakerList
            .querySelectorAll(".speaker-delete-btn")
            .forEach((btn) => {
              btn.addEventListener("click", (e) => {
                const index = parseInt(e.target.dataset.index);
                this.removeSpeaker(index);
              });
            });

          // æ‹–æ‹½æ’åº
          this.speakerList.querySelectorAll(".speaker-item").forEach((item) => {
            item.addEventListener("dragstart", (e) => this.handleDragStart(e));
            item.addEventListener("dragover", (e) => this.handleDragOver(e));
            item.addEventListener("drop", (e) => this.handleDrop(e));
            item.addEventListener("dragend", (e) => this.handleDragEnd(e));
          });
        }

        handleDragStart(e) {
          this.draggedItem = e.target.closest(".speaker-item");
          this.draggedItem.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
        }

        handleDragOver(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        }

        handleDrop(e) {
          e.preventDefault();
          const target = e.target.closest(".speaker-item");
          if (target && this.draggedItem && target !== this.draggedItem) {
            const fromIndex = parseInt(this.draggedItem.dataset.index);
            const toIndex = parseInt(target.dataset.index);

            const [removed] = this.speakers.splice(fromIndex, 1);
            this.speakers.splice(toIndex, 0, removed);
            this.renderSpeakerList();
          }
        }

        handleDragEnd(e) {
          if (this.draggedItem) {
            this.draggedItem.classList.remove("dragging");
            this.draggedItem = null;
          }
        }

        addSpeaker() {
          this.speakers.push({
            name: "",
            minutes: 5,
            seconds: 0,
          });
          this.renderSpeakerList();

          // èšç„¦åˆ°æ–°æ·»åŠ çš„è¾“å…¥æ¡†
          const lastInput = this.speakerList.querySelector(
            ".speaker-item:last-child .speaker-name-input",
          );
          if (lastInput) lastInput.focus();
        }

        removeSpeaker(index) {
          this.speakers.splice(index, 1);
          this.renderSpeakerList();
        }

        clearAgenda() {
          if (this.speakers.length === 0) return;
          this.speakers = [];
          this.renderSpeakerList();
        }

        showClearConfirmDialog() {
          if (!this.clearConfirmDialog) {
            // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
            const dialog = document.createElement("div");
            dialog.className = "confirm-dialog";
            dialog.id = "clearConfirmDialog";
            dialog.innerHTML = `
              <p>ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®®ç¨‹å—ï¼Ÿ</p>
              <div class="confirm-dialog-buttons">
                <button id="clearConfirmYes">ç¡®å®š</button>
                <button id="clearConfirmNo">å–æ¶ˆ</button>
              </div>
            `;
            document.body.appendChild(dialog);

            const overlay = document.createElement("div");
            overlay.className = "confirm-dialog-overlay";
            overlay.id = "clearConfirmOverlay";
            document.body.appendChild(overlay);

            this.clearConfirmDialog = dialog;
            this.clearConfirmOverlay = overlay;
            this.clearConfirmYesBtn =
              document.getElementById("clearConfirmYes");
            this.clearConfirmNoBtn = document.getElementById("clearConfirmNo");

            // ç»‘å®šç¡®è®¤æŒ‰é’®äº‹ä»¶
            this.clearConfirmYesBtn.addEventListener("click", () => {
              this.clearAgenda();
              this.hideClearConfirmDialog();
            });

            this.clearConfirmNoBtn.addEventListener("click", () => {
              this.hideClearConfirmDialog();
            });

            overlay.addEventListener("click", () => {
              this.hideClearConfirmDialog();
            });
          }

          this.clearConfirmDialog.style.display = "block";
          this.clearConfirmOverlay.style.display = "block";
        }

        hideClearConfirmDialog() {
          if (this.clearConfirmDialog) {
            this.clearConfirmDialog.style.display = "none";
            this.clearConfirmOverlay.style.display = "none";
          }
        }

        exportAsJson() {
          if (this.speakers.length === 0) {
            const lang = localStorage.getItem("language") || "zh";
            const msg = lang === "zh" ? "æ²¡æœ‰è®®ç¨‹å¯å¯¼å‡º" : "No agenda to export";
            if (window.timeKeeper && window.timeKeeper.showToast) {
              window.timeKeeper.showToast(msg);
            } else {
              alert(msg);
            }
            return;
          }

          const data = {
            speakers: this.speakers,
            exportTime: new Date().toLocaleString(),
          };

          this.downloadFile(
            JSON.stringify(data, null, 2),
            `ä¼šè®®è®®ç¨‹_${this.getTimestamp()}.json`,
            "application/json",
          );
        }

        exportAsCsv() {
          if (this.speakers.length === 0) {
            const lang = localStorage.getItem("language") || "zh";
            const msg = lang === "zh" ? "æ²¡æœ‰è®®ç¨‹å¯å¯¼å‡º" : "No agenda to export";
            if (window.timeKeeper && window.timeKeeper.showToast) {
              window.timeKeeper.showToast(msg);
            } else {
              alert(msg);
            }
            return;
          }

          // CSV Header
          let csvContent = "å§“å,åˆ†é’Ÿ,ç§’æ•°\n";

          // CSV Body
          this.speakers.forEach((speaker) => {
            // Escape quotes in name: "Name" -> ""Name""
            const name = speaker.name
              ? `"${speaker.name.replace(/"/g, '""')}"`
              : '""';
            const minutes = speaker.minutes || 0;
            const seconds = speaker.seconds || 0;
            csvContent += `${name},${minutes},${seconds}\n`;
          });

          // Add BOM for Excel UTF-8 compatibility
          this.downloadFile(
            "\uFEFF" + csvContent,
            `ä¼šè®®è®®ç¨‹_${this.getTimestamp()}.csv`,
            "text/csv;charset=utf-8;",
          );
        }

        downloadFile(content, filename, type) {
          const blob = new Blob([content], { type: type });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);
        }

        getTimestamp() {
          return new Date().toLocaleDateString().replace(/\//g, "-");
        }

        handleFileDragOver(e) {
          e.preventDefault();
          e.stopPropagation();
          // Only highlight if dragging files
          if (
            e.dataTransfer.types &&
            Array.from(e.dataTransfer.types).includes("Files")
          ) {
            this.panel.classList.add("dragging-file");
          }
        }

        handleFileDragLeave(e) {
          e.preventDefault();
          e.stopPropagation();
          if (e.target === this.panel) {
            this.panel.classList.remove("dragging-file");
          }
        }

        handleFileDrop(e) {
          e.preventDefault();
          e.stopPropagation();
          this.panel.classList.remove("dragging-file");

          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            const file = e.dataTransfer.files[0];
            this.processFile(file);
          }
        }

        importAgenda(e) {
          const file = e.target.files[0];
          if (file) {
            this.processFile(file);
          }
          e.target.value = ""; // é‡ç½®ä»¥å…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
        }

        processFile(file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const content = event.target.result;
              if (file.name.endsWith(".csv")) {
                this.parseCsv(content);
              } else {
                // Default to JSON
                const data = JSON.parse(content);
                if (data.speakers && Array.isArray(data.speakers)) {
                  this.speakers = data.speakers;
                  this.renderSpeakerList();
                  alert("å¯¼å…¥ JSON æˆåŠŸï¼");
                } else {
                  alert("æ— æ•ˆçš„ JSON è®®ç¨‹æ–‡ä»¶");
                }
              }
            } catch (error) {
              alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯");
              console.error("å¯¼å…¥è®®ç¨‹å¤±è´¥:", error);
            }
          };
          reader.readAsText(file);
          e.target.value = ""; // é‡ç½®ä»¥å…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
        }

        parseCsv(content) {
          const lines = content.split(/\r\n|\n/);
          const newSpeakers = [];

          // Iterate lines, skipping header if likely present
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // Simple check for header line (contains "å§“å" or "Name")
            if (
              i === 0 &&
              (line.includes("å§“å") || line.toLowerCase().includes("name"))
            ) {
              continue;
            }

            // Simple CSV parser: handles quoted fields
            const parts = [];
            let current = "";
            let inQuote = false;

            for (let char of line) {
              if (char === '"') {
                inQuote = !inQuote;
              } else if (char === "," && !inQuote) {
                parts.push(current);
                current = "";
              } else {
                current += char;
              }
            }
            parts.push(current);

            if (parts.length >= 3) {
              // Extract data: Name (remove quotes), Minutes, Seconds
              let name = parts[0].trim();
              if (name.startsWith('"') && name.endsWith('"')) {
                name = name.slice(1, -1).replace(/""/g, '"');
              }

              const minutes = parseInt(parts[1]) || 0;
              const seconds = parseInt(parts[2]) || 0;

              newSpeakers.push({ name, minutes, seconds });
            }
          }

          if (newSpeakers.length > 0) {
            this.speakers = newSpeakers;
            this.renderSpeakerList();
            alert("å¯¼å…¥ CSV æˆåŠŸï¼");
          } else {
            alert("æœªä» CSV æ–‡ä»¶ä¸­è¯»å–åˆ°æœ‰æ•ˆæ•°æ®");
          }
        }

        applyAndClose() {
          // å…ˆä»é…ç½®é¢æ¿ DOM åŒæ­¥æœ€æ–°ç¼–è¾‘åˆ° this.speakersï¼Œé¿å…æ¼æ‰æœªè§¦å‘çš„ input ç­‰
          this.flushSpeakerListFromDOM();

          // è¿‡æ»¤æ‰æ— æ•ˆçš„æ¼”è®²è€…ï¼ˆå§“åä¸ºç©ºçš„ï¼‰
          this.speakers = this.speakers.filter((s) => s.name && s.name.trim());

          // ä¿å­˜åˆ° localStorage
          this.saveToStorage();

          // æ›´æ–°å…¨å±€é…ç½®
          window.TIMEKEEPER_CONFIG = window.TIMEKEEPER_CONFIG || {};
          window.TIMEKEEPER_CONFIG.speakers = [...this.speakers];

          if (!window.timeKeeper) {
            this.closePanel();
            return;
          }

          const tk = window.timeKeeper;
          // å…ˆå†™å…¥è®®ç¨‹ä¸æ¨¡å¼ï¼Œå† resetï¼Œè¿™æ · reset å†…å¯¹â€œæ˜¯å¦è®®ç¨‹æ¨¡å¼â€çš„åˆ¤æ–­æ˜¯å‡†ç¡®çš„
          tk.agendaSpeakers = [...this.speakers];
          tk.isAgendaMode = this.speakers.length > 0;

          tk.reset();

          if (this.speakers.length > 0) {
            tk.currentSpeakerIndex = 0;
            tk.setCurrentSpeaker(0);
            const first = this.speakers[0];
            const totalSeconds =
              (parseInt(first.minutes, 10) || 0) * 60 +
              (parseInt(first.seconds, 10) || 0);
            tk.timeLeft = totalSeconds;
            tk.initialTime = totalSeconds;
            tk.updateDisplay();
          } else {
            tk.exitAgendaMode();
          }
          tk.updateButtonStates();

          this.closePanel();
        }

        // å°†é…ç½®é¢æ¿ä¸­å½“å‰åˆ—è¡¨çš„è¾“å…¥æ¡†å†…å®¹å†™å› this.speakersï¼ˆä¿å­˜å¹¶åº”ç”¨å‰åŒæ­¥ï¼‰
        flushSpeakerListFromDOM() {
          const items = this.speakerList.querySelectorAll(".speaker-item");
          this.speakers = Array.from(items).map((el) => {
            const nameEl = el.querySelector(".speaker-name-input");
            const minEl = el.querySelector(
              '.speaker-time-input[data-field="minutes"]',
            );
            const secEl = el.querySelector(
              '.speaker-time-input[data-field="seconds"]',
            );
            return {
              name: nameEl ? nameEl.value.trim() : "",
              minutes: minEl ? parseInt(minEl.value, 10) || 0 : 0,
              seconds: secEl ? parseInt(secEl.value, 10) || 0 : 0,
            };
          });
        }

        escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text || "";
          return div.innerHTML;
        }
      }

      // åˆå§‹åŒ–æ»šåŠ¨æŒ‡ç¤ºå™¨
      document.addEventListener("DOMContentLoaded", function () {
        const records = document.querySelector(".records");
        const scrollIndicator = document.querySelector(".scroll-indicator");

        function updateScrollIndicator() {
          if (records.scrollHeight > records.clientHeight) {
            if (
              records.scrollHeight - records.scrollTop - records.clientHeight >
              10
            ) {
              scrollIndicator.style.opacity = "1";
            } else {
              scrollIndicator.style.opacity = "0";
            }
          } else {
            scrollIndicator.style.opacity = "0";
          }
        }

        records.addEventListener("scroll", updateScrollIndicator);
        const recordList = document.getElementById("recordList");
        const observer = new MutationObserver(updateScrollIndicator);
        observer.observe(recordList, { childList: true });

        // åˆå§‹åŒ–è®®ç¨‹ç®¡ç†å™¨
        window.agendaManager = new AgendaManager();

        // åˆå§‹åŒ–è¯­è¨€åˆ‡æ¢åŠŸèƒ½
        initLanguageToggle();
      });

      // ========== è¯­è¨€åˆ‡æ¢åŠŸèƒ½ ==========
      function initLanguageToggle() {
        const langBtn = document.getElementById("langToggleBtn");
        let currentLang = localStorage.getItem("language") || "zh";

        // è¯­è¨€é…ç½®
        const translations = {
          zh: {
            speakerPlaceholder: "æ¼”è®²è€…",
            minutesPlaceholder: "åˆ†",
            secondsPlaceholder: "ç§’",
            startBtn: "å¼€å§‹",
            stopBtn: "åœæ­¢",
            recordsTitle: "æ¼”è®²æ—¶é—´è®°å½•",
            exportBtn: "å¯¼å‡º",
            clearBtn: "æ¸…ç©º",
            confirmStop: "ç¡®å®šç»“æŸè®¡æ—¶å—ï¼Ÿ",
            confirmYes: "ç¡®å®š",
            confirmNo: "å–æ¶ˆ",
            configTitle: "ğŸ“‹ ä¼šè®®è®®ç¨‹é…ç½®",
            addSpeaker: "+ æ·»åŠ æ¼”è®²è€…",
            dragHint: "æ”¯æŒæ‹–æ‹½ .csv / .json æ–‡ä»¶è‡³æ­¤åŒºåŸŸç›´æ¥å¯¼å…¥",
            importBtn: "å¯¼å…¥",
            exportAgendaBtn: "å¯¼å‡º",
            clearAgendaBtn: "æ¸…ç©º",
            applyBtn: "ä¿å­˜å¹¶åº”ç”¨",
            exportDialogTitle: "è¯·é€‰æ‹©å¯¼å‡ºæ ¼å¼",
            exportJson: "JSON (å¤‡ä»½)",
            exportCsv: "CSV (Excel)",
            exportCancel: "å–æ¶ˆ",
            namePlaceholder: "å§“å",
            minuteLabel: "åˆ†",
            secondLabel: "ç§’",
            emptyHint1: "æš‚æ— æ¼”è®²è€…",
            emptyHint2: "ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ¼”è®²è€…",
            langBtn: "ä¸­",
            langTitle: "åˆ‡æ¢è¯­è¨€",
            configBtnTitle: "è®®ç¨‹é…ç½®",
          },
          en: {
            speakerPlaceholder: "Speaker",
            minutesPlaceholder: "Min",
            secondsPlaceholder: "Sec",
            startBtn: "Start",
            stopBtn: "Stop",
            recordsTitle: "Speaking Records",
            exportBtn: "Export",
            clearBtn: "Clear",
            confirmStop: "Confirm to stop timing?",
            confirmYes: "Yes",
            confirmNo: "No",
            configTitle: "ğŸ“‹ Agenda Config",
            addSpeaker: "+ Add Speaker",
            dragHint: "Drag .csv / .json file here to import",
            importBtn: "Import",
            exportAgendaBtn: "Export",
            clearAgendaBtn: "Clear",
            applyBtn: "Save & Apply",
            exportDialogTitle: "Select Export Format",
            exportJson: "JSON (Backup)",
            exportCsv: "CSV (Excel)",
            exportCancel: "Cancel",
            namePlaceholder: "Name",
            minuteLabel: "min",
            secondLabel: "sec",
            emptyHint1: "No speakers yet",
            emptyHint2: "Click below to add speakers",
            langBtn: "EN",
            langTitle: "Switch Language",
            configBtnTitle: "Agenda Config",
          },
        };

        // åº”ç”¨è¯­è¨€
        function applyLanguage(lang) {
          const t = translations[lang];
          document.getElementById("speakerName").placeholder =
            t.speakerPlaceholder;
          document.getElementById("minutes").placeholder = t.minutesPlaceholder;
          document.getElementById("seconds").placeholder = t.secondsPlaceholder;
          document.getElementById("startBtn").textContent = t.startBtn;
          document.getElementById("stopBtn").textContent = t.stopBtn;
          document.querySelector(".records-title h2").textContent =
            t.recordsTitle;
          document.querySelector(".export-btn").textContent = t.exportBtn;
          document.querySelector(".clear-btn").textContent = t.clearBtn;
          document.querySelector(".confirm-dialog p").textContent =
            t.confirmStop;
          document.getElementById("confirmYes").textContent = t.confirmYes;
          document.getElementById("confirmNo").textContent = t.confirmNo;
          document.querySelector(".config-panel-header h3").textContent =
            t.configTitle;
          document.getElementById("addSpeakerBtn").textContent = t.addSpeaker;
          document.querySelector(".drag-hint").textContent = t.dragHint;
          document.getElementById("importAgendaBtn").textContent = t.importBtn;
          document.getElementById("exportAgendaBtn").textContent =
            t.exportAgendaBtn;
          document.getElementById("clearAgendaBtn").textContent =
            t.clearAgendaBtn;
          document.getElementById("applyAgendaBtn").textContent = t.applyBtn;
          document.querySelector("#exportDialog p").textContent =
            t.exportDialogTitle;
          document.getElementById("exportJsonBtn").textContent = t.exportJson;
          document.getElementById("exportCsvBtn").textContent = t.exportCsv;
          document.getElementById("exportCancelBtn").textContent =
            t.exportCancel;
          langBtn.textContent = t.langBtn;
          langBtn.title = t.langTitle;
          document.getElementById("configToggleBtn").title = t.configBtnTitle;
          document.documentElement.lang = lang;

          // æ›´æ–°é…ç½®é¢æ¿ä¸­çš„æ ‡ç­¾ï¼ˆå¦‚æœå·²æ¸²æŸ“ï¼‰
          const speakerLabels = document.querySelectorAll(
            ".speaker-time-label",
          );
          speakerLabels.forEach((label, index) => {
            label.textContent = index % 2 === 0 ? t.minuteLabel : t.secondLabel;
          });

          // æ›´æ–°ç©ºçŠ¶æ€æç¤º
          const emptyHint = document.querySelector(".empty-speakers-hint");
          if (emptyHint) {
            emptyHint.innerHTML = `
              <p>${t.emptyHint1}</p>
              <p>${t.emptyHint2}</p>
            `;
          }

          // æ›´æ–°è¾“å…¥æ¡†çš„ placeholder
          const nameInputs = document.querySelectorAll(".speaker-name-input");
          nameInputs.forEach((input) => {
            input.placeholder = t.namePlaceholder;
          });

          // æ›´æ–°æ¸…ç©ºç¡®è®¤å¯¹è¯æ¡†çš„æ–‡æœ¬
          const clearDialog = document.getElementById("clearConfirmDialog");
          if (clearDialog) {
            const p = clearDialog.querySelector("p");
            const yesBtn = document.getElementById("clearConfirmYes");
            const noBtn = document.getElementById("clearConfirmNo");
            if (p)
              p.textContent =
                lang === "zh"
                  ? "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®®ç¨‹å—ï¼Ÿ"
                  : "Clear all agenda items?";
            if (yesBtn) yesBtn.textContent = t.confirmYes;
            if (noBtn) noBtn.textContent = t.confirmNo;
          }
        }

        // åˆ‡æ¢è¯­è¨€
        function toggleLanguage() {
          currentLang = currentLang === "zh" ? "en" : "zh";
          localStorage.setItem("language", currentLang);
          applyLanguage(currentLang);

          // æ·»åŠ æ¿€æ´»åŠ¨ç”»
          langBtn.classList.add("active");
          setTimeout(() => {
            langBtn.classList.remove("active");
          }, 300);
        }

        // åˆå§‹åŒ–è¯­è¨€
        applyLanguage(currentLang);

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        langBtn.addEventListener("click", toggleLanguage);
      }

      // ========== ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ==========
      {
        const themeBtn = document.getElementById("themeToggleBtn");
        let currentTheme = localStorage.getItem("theme") || "dark";

        // åº”ç”¨ä¸»é¢˜
        function applyTheme(theme) {
          const lang = localStorage.getItem("language") || "zh";
          if (theme === "light") {
            document.body.classList.add("light-theme");
            themeBtn.textContent = "ğŸŒ™";
            themeBtn.title =
              lang === "zh" ? "åˆ‡æ¢åˆ°é»‘å¤œæ¨¡å¼" : "Switch to dark mode";
          } else {
            document.body.classList.remove("light-theme");
            themeBtn.textContent = "â˜€ï¸";
            themeBtn.title =
              lang === "zh" ? "åˆ‡æ¢åˆ°ç™½å¤©æ¨¡å¼" : "Switch to light mode";
          }
        }

        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
          currentTheme = currentTheme === "dark" ? "light" : "dark";
          localStorage.setItem("theme", currentTheme);
          applyTheme(currentTheme);

          // æ·»åŠ æ¿€æ´»åŠ¨ç”»
          themeBtn.classList.add("active");
          setTimeout(() => {
            themeBtn.classList.remove("active");
          }, 300);
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        applyTheme(currentTheme);

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        themeBtn.addEventListener("click", toggleTheme);
      }
    </script>
  </body>
</html>
